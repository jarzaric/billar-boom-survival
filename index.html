<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Billar Survival - Mobile Pro</title>
    <style>
        body { background: #1a1a1a; display: flex; flex-direction: column; align-items: center; color: white; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; touch-action: none; }
        
        /* Contenedor de la mesa */
        .table-frame { 
            padding: 10px; background: #3e2723; border: 4px solid #2a1b18; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); margin-top: 5px; 
            border-radius: 12px; position: relative; 
        }

        canvas { 
            background: #074e1d; display: block; cursor: crosshair; 
            max-width: 95vw; max-height: 65vh; height: auto; 
            image-rendering: auto; border-radius: 4px;
        }

        /* Bot√≥n de Pausa T√°ctil */
        .mobile-pause-btn {
            position: absolute; top: 20px; right: 20px; width: 45px; height: 45px;
            background: rgba(0, 0, 0, 0.6); color: white; border: 2px solid #4caf50;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; cursor: pointer; z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); -webkit-tap-highlight-color: transparent;
        }

        /* Men√∫s */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .menu-card { background: #2c2c2c; padding: 25px; border: 4px solid #4caf50; text-align: center; width: 85%; max-width: 480px; box-shadow: 8px 8px 0px #000; border-radius: 15px; }
        
        .guide-grid { display: grid; grid-template-columns: 30px 1fr; gap: 10px; text-align: left; background: #111; padding: 15px; margin: 15px 0; font-size: 13px; border-radius: 10px; border: 1px solid #444; }
        .dot { width: 16px; height: 16px; border-radius: 50%; border: 1px solid #fff; align-self: center; }
        
        input[type=range] { width: 100%; accent-color: #4caf50; height: 25px; }
        
        button { background: #4caf50; border: none; padding: 15px 30px; color: white; font-weight: bold; font-size: 18px; cursor: pointer; box-shadow: 4px 4px 0px #1b5e20; margin: 10px; border-radius: 8px; }
        button:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0px #1b5e20; }

        .stats { display: flex; justify-content: center; gap: 20px; background: #333; padding: 10px 20px; border: 2px solid #555; margin-top: 8px; border-radius: 20px; width: fit-content; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="start-menu" class="overlay">
        <div class="menu-card">
            <h1 style="color: #4caf50; margin: 0;">BILLAR SURVIVAL</h1>
            <p id="record-text" style="color: #ffeb3b;">üèÜ R√âCORD: NIVEL 1</p>
            
            <div class="guide-grid">
                <div class="dot" style="background: red;"></div> <div><b>ROJA:</b> Explosi√≥n letal.</div>
                <div class="dot" style="background: #00fbff;"></div> <div><b>AZUL:</b> Escudo Inmune (5s).</div>
                <div class="dot" style="background: #b400ff;"></div> <div><b>MORADA:</b> Ralentiza la bola.</div>
            </div>

            <div style="background: #111; padding: 10px; border-radius: 10px;">
                <span id="diff-label" style="font-weight: bold; color: #4deeea;">DIFICULTAD: BASE</span>
                <input type="range" id="diff-slider" min="0" max="5" value="0" oninput="updateDiff(this.value)">
            </div>
            <button onclick="startGame()">JUGAR AHORA</button>
        </div>
    </div>

    <div id="pause-menu" class="overlay hidden">
        <div class="menu-card">
            <h1 style="color: #4deeea;">JUEGO EN PAUSA</h1>
            <button onclick="togglePause()">REANUDAR</button><br>
            <button onclick="location.reload()" style="background: #f44336; box-shadow: 4px 4px 0px #b71c1c;">SALIR AL MEN√ö</button>
        </div>
    </div>

    <div id="game-over" class="overlay hidden">
        <div class="menu-card">
            <h1 style="color: #ff5252;">¬°BOOM!</h1>
            <p id="death-reason" style="color: #aaa;"></p>
            <div style="font-size: 28px; margin: 10px 0;">NIVEL: <span id="final-lvl">1</span></div>
            <button onclick="location.reload()">REINTENTAR</button>
        </div>
    </div>

    <div class="stats">
        <div>LVL: <span id="lvl-val">1</span></div>
        <div>‚è±Ô∏è: <span id="timer">01:30</span></div>
        <div id="status-effect" style="color:#00fbff; font-weight: bold;"></div>
    </div>

    <div class="table-frame">
        <div class="mobile-pause-btn" onclick="togglePause()">||</div>
        <canvas id="gameCanvas" width="900" height="550"></canvas>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    let ball, zones, particles, timeLeft, level, difficultyMultiplier, spawnRate, warningTime;
    let isStarted = false, isPaused = false, gameOver = false, isDrawing = false, curPos = {x:0, y:0};
    let gameIntervals = [];

    const diffs = [
        {name: "BASE", mult: 1.0, col: "#4deeea"},
        {name: "DIFICIL", mult: 1.4, col: "#4caf50"},
        {name: "TREMENDO", mult: 1.8, col: "#ffeb3b"},
        {name: "DUR√çSIMO", mult: 2.2, col: "#ff9800"},
        {name: "EXTREMO", mult: 2.6, col: "#f44336"},
        {name: "LOCURA", mult: 3.2, col: "#9c27b0"}
    ];

    function updateDiff(v) {
        document.getElementById('diff-label').innerText = "DIFICULTAD: " + diffs[v].name;
        document.getElementById('diff-label').style.color = diffs[v].col;
    }

    function playSound(f, t, d, v=0.1) {
        if(!isStarted || isPaused || audioCtx.state === 'suspended') return;
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime);
        g.gain.setValueAtTime(v, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + d);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + d);
    }

    class Pixel {
        constructor(x,y,c) {
            this.x=x; this.y=y; this.c=c;
            this.vx=(Math.random()-0.5)*4; this.vy=(Math.random()-0.5)*4;
            this.l=1.0; this.s=Math.random()*3+2;
        }
        update() { this.x+=this.vx; this.y+=this.vy; this.l-=0.02; }
        draw() { ctx.globalAlpha=this.l; ctx.fillStyle=this.c; ctx.fillRect(this.x,this.y,this.s,this.s); ctx.globalAlpha=1; }
    }

    function init() {
        const d = diffs[document.getElementById('diff-slider').value];
        difficultyMultiplier = d.mult;
        ball = { x: 450, y: 275, vx: 0, vy: 0, r: 15, f: 0.985, immune: false };
        zones = []; particles = []; timeLeft = 90; level = 1;
        spawnRate = 1800 / difficultyMultiplier; 
        warningTime = 180 / difficultyMultiplier;
        document.getElementById('record-text').innerText = "üèÜ R√âCORD: NIVEL " + (localStorage.getItem('billarHigh') || 1);
    }

    function startGame() {
        init(); isStarted = true; document.getElementById('start-menu').classList.add('hidden');
        if(audioCtx.state === 'suspended') audioCtx.resume();
        startLoops();
    }

    function togglePause() {
        if(!isStarted || gameOver) return;
        isPaused = !isPaused;
        document.getElementById('pause-menu').classList.toggle('hidden', !isPaused);
    }

    function startLoops() {
        gameIntervals.forEach(clearInterval);
        gameIntervals = [
            setInterval(() => {
                if(gameOver || isPaused) return;
                if(timeLeft > 0) {
                    timeLeft--;
                    document.getElementById('timer').innerText = `0${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2,'0')}`;
                } else {
                    level++; difficultyMultiplier *= 1.1; 
                    spawnRate = Math.max(450, 1800/difficultyMultiplier);
                    timeLeft = 90; document.getElementById('lvl-val').innerText = level;
                }
            }, 1000),
            setInterval(() => { if(!gameOver && !isPaused) spawnZone('red'); }, spawnRate),
            setInterval(() => { if(!gameOver && !isPaused) { spawnZone('blue'); spawnZone('purple'); } }, 12000)
        ];
    }

    function spawnZone(type) {
        let r = (type === 'red') ? 60 : 45;
        zones.push({x: Math.random()*800+50, y: Math.random()*450+50, r: r, type: type, a: 0, active: (type !== 'red')});
    }

    function endGame(reason) {
        gameOver = true;
        if (navigator.vibrate) navigator.vibrate([200, 50, 200]);
        document.getElementById('death-reason').innerText = "Causa: " + reason;
        document.getElementById('final-lvl').innerText = level;
        document.getElementById('game-over').classList.remove('hidden');
        if(level > (localStorage.getItem('billarHigh')||0)) localStorage.setItem('billarHigh', level);
    }

    function getPos(e) {
        let r = canvas.getBoundingClientRect();
        let cx = e.touches ? e.touches[0].clientX : e.clientX;
        let cy = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: (cx - r.left)*(900/r.width), y: (cy - r.top)*(550/r.height) };
    }

    const hStart = (e) => { if(ball.vx===0 && isStarted && !isPaused) { isDrawing=true; curPos=getPos(e); } };
    const hMove = (e) => { curPos=getPos(e); if(isDrawing) e.preventDefault(); };
    const hEnd = () => { if(isDrawing) { playSound(300,'triangle',0.1); ball.vx=(ball.x-curPos.x)*0.14; ball.vy=(ball.y-curPos.y)*0.14; isDrawing=false; } };

    window.addEventListener('keydown', (e) => { if(e.key.toLowerCase()==='p' || e.key==='Escape') togglePause(); });
    canvas.addEventListener('mousedown', hStart); window.addEventListener('mousemove', hMove); window.addEventListener('mouseup', hEnd);
    canvas.addEventListener('touchstart', hStart, {passive:false}); canvas.addEventListener('touchmove', hMove, {passive:false}); canvas.addEventListener('touchend', hEnd);

    function update() {
        if(!isStarted || gameOver || isPaused) return;
        ball.x+=ball.vx; ball.y+=ball.vy;
        ball.vx*=ball.f; ball.vy*=ball.f;
        if(Math.hypot(ball.vx, ball.vy) < 0.5) { ball.vx=0; ball.vy=0; }

        if(ball.x<ball.r || ball.x>900-ball.r) { ball.vx*=-0.8; ball.x=ball.x<ball.r?ball.r:900-ball.r; playSound(150,'sine',0.05); if(navigator.vibrate) navigator.vibrate(20); }
        if(ball.y<ball.r || ball.y>550-ball.r) { ball.vy*=-0.8; ball.y=ball.y<ball.r?ball.r:550-ball.r; playSound(150,'sine',0.05); if(navigator.vibrate) navigator.vibrate(20); }

        zones.forEach((z,i) => {
            z.a++;
            if(z.type === 'red' && z.a > warningTime) z.active = true;
            let dist = Math.hypot(ball.x-z.x, ball.y-z.y);
            
            if(dist < ball.r+z.r) {
                if(z.type === 'red' && z.active && !ball.immune) endGame("EXPLOSI√ìN");
                if(z.type === 'blue') {
                    ball.immune = true;
                    document.getElementById('status-effect').innerText = "üõ°Ô∏è INMUNE";
                    playSound(600, 'sine', 0.2);
                    setTimeout(() => { ball.immune = false; document.getElementById('status-effect').innerText = ""; }, 5000);
                    zones.splice(i, 1);
                }
                if(z.type === 'purple') { ball.vx *= 0.85; ball.vy *= 0.85; }
            }
            if(Math.random()>0.8) {
                let pCol = z.type==='red'?(z.active?"red":"yellow"): (z.type==='blue'?"#00fbff":"#b400ff");
                particles.push(new Pixel(z.x+(Math.random()-0.5)*z.r, z.y+(Math.random()-0.5)*z.r, pCol));
            }
            if(z.a > warningTime*2.5) zones.splice(i,1);
        });
        particles.forEach((p,i) => { p.update(); if(p.l<=0) particles.splice(i,1); });
    }

    function draw() {
        ctx.clearRect(0,0,900,550);
        if(!isStarted) return;
        zones.forEach(z => {
            ctx.beginPath(); ctx.arc(z.x, z.y, z.r, 0, Math.PI*2);
            if(z.type === 'red') {
                ctx.fillStyle = z.active ? "rgba(255,0,0,0.3)" : "rgba(255,255,0,0.15)";
                ctx.strokeStyle = z.active ? "red" : "yellow";
            } else if(z.type === 'blue') {
                ctx.fillStyle = "rgba(0,251,255,0.2)"; ctx.strokeStyle = "#00fbff";
            } else { ctx.fillStyle = "rgba(180,0,255,0.2)"; ctx.strokeStyle = "#b400ff"; }
            ctx.lineWidth=3; ctx.fill(); ctx.stroke();
        });
        particles.forEach(p => p.draw());

        ctx.save();
        if(ball.immune) { ctx.shadowBlur = 15; ctx.shadowColor = "#00fbff"; }
        ctx.fillStyle = ball.immune ? "#00fbff" : "white";
        ctx.beginPath(); ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle="black"; ctx.lineWidth=2; ctx.stroke();
        ctx.restore();
        
        if(isDrawing) {
            let dx=ball.x-curPos.x, dy=ball.y-curPos.y, ang=Math.atan2(dy,dx), dist=Math.hypot(dx,dy);
            ctx.save(); ctx.translate(ball.x,ball.y); ctx.rotate(ang);
            ctx.fillStyle="#5d4037"; ctx.fillRect(-dist-150, -4, 150, 8);
            ctx.fillStyle="#d7ccc8"; ctx.fillRect(-dist-10, -4, 10, 8);
            ctx.restore();
            ctx.setLineDash([8,8]); ctx.strokeStyle="rgba(255,255,255,0.5)";
            ctx.beginPath(); ctx.moveTo(ball.x,ball.y);
            ctx.lineTo(ball.x+Math.cos(ang)*600, ball.y+Math.sin(ang)*600); ctx.stroke();
            ctx.setLineDash([]);
        }
    }

    function run() { update(); draw(); requestAnimationFrame(run); }
    run();
</script>
</body>
</html>
