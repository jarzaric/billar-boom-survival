<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Billar Survival - Mobile Pro</title>
    <style>
        body { background: #1a1a1a; display: flex; flex-direction: column; align-items: center; color: white; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; touch-action: none; }
        
        /* Contenedor de la mesa */
        .table-frame { 
            padding: 10px; background: #3e2723; border: 4px solid #2a1b18; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.8); margin-top: 5px; 
            border-radius: 12px; position: relative; 
        }

        canvas { 
            background: #074e1d; display: block; cursor: crosshair; 
            max-width: 95vw; max-height: 65vh; height: auto; 
            image-rendering: auto; border-radius: 4px;
        }

        /* Bot√≥n de Pausa T√°ctil */
        .mobile-pause-btn {
            position: absolute; top: 10px; right: 500px; width: 45px; height: 45px;
            background: rgba(0, 0, 0, 0.6); color: white; border: 2px solid #4caf50;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; cursor: pointer; z-index: 10;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); -webkit-tap-highlight-color: transparent;
        }

        /* Men√∫s */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .menu-card { background: #2c2c2c; padding: 25px; border: 4px solid #4caf50; text-align: center; width: 85%; max-width: 480px; box-shadow: 8px 8px 0px #000; border-radius: 15px; }
        
        .guide-grid { display: grid; grid-template-columns: 30px 1fr; gap: 10px; text-align: left; background: #111; padding: 15px; margin: 15px 0; font-size: 13px; border-radius: 10px; border: 1px solid #444; }
        .dot { width: 16px; height: 16px; border-radius: 50%; border: 1px solid #fff; align-self: center; }
        
        input[type=range] { width: 100%; accent-color: #4caf50; height: 25px; }
        
        button { background: #4caf50; border: none; padding: 15px 30px; color: white; font-weight: bold; font-size: 18px; cursor: pointer; box-shadow: 4px 4px 0px #1b5e20; margin: 10px; border-radius: 8px; }
        button:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0px #1b5e20; }

        .stats { display: flex; justify-content: center; gap: 20px; background: #333; padding: 10px 20px; border: 2px solid #555; margin-top: 8px; border-radius: 20px; width: fit-content; }
        .hidden { display: none !important; }
.energy-container { 
            width: 90%; max-width: 900px; height: 12px; 
            background: #444; margin: 10px auto; 
            border-radius: 6px; overflow: hidden; border: 1px solid #000; 
        }
        #energy-bar { 
            width: 100%; height: 100%; background: #ffeb3b; 
            transition: width 0.1s linear; 
        }
        #skin-list {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap; 
    max-height: 200px;
    overflow-y: auto;
    padding: 10px;
}
    </style>
</head>
<body>

<div id="control-selection-menu" class="overlay">
    <div class="menu-card">
        <h1 style="color: #4caf50; margin: 0;">CONFIGURACI√ìN</h1>
        <p>Selecciona tus controles antes de jugar:</p>
        
        <div class="option" onclick="selectControl(1)" style="background: #111; padding: 15px; margin: 10px; border-radius: 10px; border: 2px solid #4caf50; cursor: pointer;">
            <strong>CONTROL 1: DIRECTO</strong>
            <p><small>La bola va hacia donde apuntas con el dedo o mouse.</small></p>
        </div>
        
        <div class="option" onclick="selectControl(2)" style="background: #111; padding: 15px; margin: 10px; border-radius: 10px; border: 2px solid #888; cursor: pointer;">
            <strong>CONTROL 2: HONDA</strong>
            <p><small>Tira hacia atr√°s de la bola para disparar.</small></p>
        </div>
    </div>
</div>

<div id="start-menu" class="overlay hidden">
    <div class="menu-card">
        <h1 style="color: #4caf50; margin: 0;">BILLAR BOOM SURVIVAL</h1>
        <p id="record-text" style="color: #ffeb3b;">üèÜ R√âCORD: NIVEL 1</p>
         <p id="guide-text" style="color: #999999;">INSTRUCCIONES:</p>
        <div class="guide-grid">
            <div class="dot" style="background: yellow;"></div> <div><b>AMARILLA:</b> Zona de advertencia.</div>
            <div class="dot" style="background: red;"></div> <div><b>ROJA:</b> Explosi√≥n letal.</div>
            <div class="dot" style="background: #00fbff;"></div> <div><b>AZUL:</b> Escudo de Inmunidad (10s).</div>
            <div class="dot" style="background: #b400ff;"></div> <div><b>MORADA:</b> Frena la bola.</div>
        </div>

        <div style="background: #111; padding: 10px; border-radius: 10px;">
            <span id="diff-label" style="font-weight: bold; color: #4deeea;">DIFICULTAD: BASE</span>
            <input type="range" id="diff-slider" min="0" max="5" value="0" oninput="updateDiff(this.value)">
        </div>
        <button onclick="startGame()">¬°JUGAR AHORA!</button>
        <p><small onclick="location.reload()" style="cursor:pointer; color: #888;">‚Üê Cambiar Control</small></p>
    </div>
</div>

<div id="pause-menu" class="overlay hidden">
    <div class="menu-card">
    <h2 style="color: #4deeea; margin: 5px;">TIENDA DE SKINS</h2>
    <p>Tus Coins: üí∞ <span id="coin-count-ui">0</span></p>
    <div id="skin-list" style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;"></div>
    <button onclick="togglePause()">REANUDAR</button><br>
    <button onclick="location.reload()" style="background: #f44336; font-size: 14px;">SALIR</button>
</div>
</div>
    
<div id="game-over" class="overlay hidden">
        <div class="menu-card">
            <h1 style="color: #ff5252;">¬°BOOM!</h1>
            <p id="death-reason" style="color: #aaa;"></p>
            <div style="font-size: 28px; margin: 10px 0;">NIVEL: <span id="final-lvl">1</span></div>
           <button onclick="resetGame()">REINTENTAR</button>
        
        <br>
        <button onclick="location.reload()" style="background: #444; font-size: 12px; margin-top: 10px; box-shadow: 2px 2px 0px #222;">
            CAMBIAR MODO DE CONTROL
        </button>
    </div>
</div>

    <div class="stats">
        <div>LVL: <span id="lvl-val">1</span></div>
        <div>‚è±Ô∏è: <span id="timer">01:30</span></div>
        <div id="status-effect" style="color:#00fbff; font-weight: bold;"></div>
        <div class="mobile-pause-btn" onclick="togglePause()">||</div>
    </div>
<div class="energy-container">
    <div id="energy-bar"></div>
</div>
<div id="camping-warning" style="color: #ff5252; font-weight: bold; font-size: 14px; text-align: center; height: 20px; opacity: 0; transition: 0.3s; margin-bottom: 5px;">
        ‚ö†Ô∏è ¬°MU√âVETE O EXPLOTAR√ÅS! ‚ö†Ô∏è
    </div>
    <div class="table-frame">
        <canvas id="gameCanvas" width="900" height="550"></canvas>
    </div>

<script>
let controlType = 1; // 1: Directo, 2: Honda
let currentDiffIndex = parseInt(localStorage.getItem('billarDiff')) || 0;
let unlockedDiffs = JSON.parse(localStorage.getItem('billarUnlockedDiffs')) || ['base'];
function selectControl(type) {
    controlType = type; // Guarda si eligi√≥ Directo o Honda
localStorage.setItem('billarControl', type); // Guarda el control
    document.getElementById('control-selection-menu').classList.add('hidden');
    document.getElementById('start-menu').classList.remove('hidden');
    const high = localStorage.getItem('billarHigh') || 1;
    document.getElementById('record-text').innerText = "üèÜ R√âCORD: NIVEL " + high;
}
let coins = parseInt(localStorage.getItem('billarCoins')) || 0;
let activeSkin = localStorage.getItem('billarSkin') || 'white';
let ownedSkins = JSON.parse(localStorage.getItem('billarOwned')) || ['white'];

// Definici√≥n de las skins disponibles
const skinStore = [
    { id: 'white', color: '#ffffff', name: 'Blanco' },
    { id: 'gold', color: '#ffd700', name: 'Oro' },
    { id: 'neon', color: '#39ff14', name: 'Ne√≥n' },
    { id: 'fire', color: '#ff4500', name: 'Fuego' },
    { id: 'ice', color: '#00fbff', name: 'Hielo' },
    { id: 'purple', color: '#b400ff', name: 'Gema' },
    { id: 'pink', color: '#ff00ff', name: 'Chicle' },
    { id: 'blood', color: '#8b0000', name: 'Sangre' },
    { id: 'ocean', color: '#0000ff', name: 'Oc√©ano' },
    { id: 'emerald', color: '#50c878', name: 'Esmeralda' },
    { id: 'orange', color: '#ff8c00', name: 'Naranja' },
    { id: 'silver', color: '#c0c0c0', name: 'Plata' },
    { id: 'obsidian', color: '#333333', name: 'Obsidiana' },
    { id: 'sunset', color: '#ff5e62', name: 'Atardecer' },
    { id: 'toxic', color: '#adff2f', name: 'T√≥xico' },
    { id: 'royal', color: '#4169e1', name: 'Real' }
];
let difficultyMultiplier = 1;
let spawnRate = 1800;
let warningTime = 300;
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    let ball, zones, particles, timeLeft, level;
    let isStarted = false, isPaused = false, gameOver = false, isDrawing = false, curPos = {x:0, y:0};
    let gameIntervals = [];
let energy = 100; 
let energyDrain = 0.15; // Velocidad de descarga
    const diffs = [
    { id: 'base', name: "BASE", mult: 1.0, freq: 1500, col: "#4deeea", price: 0 },
    { id: 'dificil', name: "DIFICIL", mult: 1.4, freq: 1200, col: "#4caf50", price: 5 },
    { id: 'tremendo', name: "TREMENDO", mult: 1.8, freq: 1000, col: "#ffeb3b", price: 10 },
    { id: 'durisimo', name: "DUR√çSIMO", mult: 2.2, freq: 800, col: "#ff9800", price: 15 },
    { id: 'extremo', name: "EXTREMO", mult: 2.6, freq: 650, col: "#f44336", price: 20 },
    { id: 'locura', name: "LOCURA", mult: 3.2, freq: 500, col: "#9c27b0", price: 25 }
];

function updateDiff(v) {
    const index = parseInt(v);
    const targetDiff = diffs[index];
    
    // 1. Si es el nivel BASE, permitir siempre
    if (index === 0) {
        applyDiff(index);
        return;
    }

    // 2. REGLA DE ESCALADA: Verificar si el nivel anterior est√° desbloqueado
    const previousDiff = diffs[index - 1];
    if (!unlockedDiffs.includes(previousDiff.id)) {
        alert(`¬°Paso a paso! Primero debes desbloquear el nivel: ${previousDiff.name}`);
        document.getElementById('diff-slider').value = currentDiffIndex;
        return;
    }

    // 3. Si ya es due√±o del nivel actual, permitir el paso
    if (unlockedDiffs.includes(targetDiff.id)) {
        applyDiff(index);
        return;
    }

    const record = parseInt(localStorage.getItem('billarHigh')) || 1;
    const levelRequired = 5; 
    
    // 4. OPCI√ìN A: Desbloqueo GRATIS por R√©cord
    if (record >= levelRequired) {
        unlockedDiffs.push(targetDiff.id);
        localStorage.setItem('billarUnlockedDiffs', JSON.stringify(unlockedDiffs));
        alert(`¬°Nivel ${targetDiff.name} desbloqueado por tu r√©cord! üèÜ`);
        applyDiff(index);
    } 
    // 5. OPCI√ìN B: Compra con Monedas
    else if (coins >= targetDiff.price) {
        if (confirm(`¬øDesbloquear ${targetDiff.name} por ${targetDiff.price} monedas?\n\n(O llega al Nivel ${levelRequired} para que sea GRATIS)`)) {
            coins -= targetDiff.price;
            unlockedDiffs.push(targetDiff.id);
            localStorage.setItem('billarCoins', coins);
            localStorage.setItem('billarUnlockedDiffs', JSON.stringify(unlockedDiffs));
            applyDiff(index);
            if(typeof updateShopUI === 'function') updateShopUI();
        } else {
            document.getElementById('diff-slider').value = currentDiffIndex;
        }
    } 
    // 6. BLOQUEADO
    else {
        alert(`BLOQUEADO: Necesitas r√©cord de Nivel ${levelRequired} o pagar ${targetDiff.price} monedas.`);
        document.getElementById('diff-slider').value = currentDiffIndex;
    }
}
    function init() {
    // Usamos el √≠ndice actual que el slider y applyDiff controlan
    const d = diffs[currentDiffIndex];
    
    difficultyMultiplier = d.mult;
    spawnRate = d.freq; 
    warningTime = d.freq / 5;
    ball = { x: 450, y: 275, vx: 0, vy: 0, r: 15, f: 0.985, immune: false };
    zones = []; particles = []; timeLeft = 90; level = 1; energy = 100;
    document.getElementById('lvl-val').innerText = level;
        
}

    function startGame() {
        init(); isStarted = true; document.getElementById('start-menu').classList.add('hidden');
        document.getElementById('control-selection-menu').classList.add('hidden');
    document.getElementById('game-over').classList.add('hidden');
if(audioCtx.state === 'suspended') audioCtx.resume();
        startLoops();
    }

    function togglePause() {
        if(!isStarted || gameOver) return;
    isPaused = !isPaused;
    const menu = document.getElementById('pause-menu');
    if(menu) menu.classList.toggle('hidden', !isPaused);
    if(isPaused) updateShopUI(); // Para que se vean las monedas al pausar
}
function startLoops() {
        gameIntervals.forEach(clearInterval);
        gameIntervals = [
            setInterval(() => {
                if(gameOver || isPaused) return;
                if(timeLeft > 0) {
                    timeLeft--;
                    document.getElementById('timer').innerText = `0${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2,'0')}`;
                } else {
                    level++; difficultyMultiplier *= 1.1; 
                    spawnRate = Math.max(450, 1800/difficultyMultiplier);
                    timeLeft = 90; document.getElementById('lvl-val').innerText = level;
                }
            }, 1000),
            setInterval(() => { if(!gameOver && !isPaused) spawnZone('red'); }, spawnRate),
            setInterval(() => { if(!gameOver && !isPaused) { spawnZone('blue'); spawnZone('purple'); } }, 16000),
            setInterval(() => {
                if(!gameOver && !isPaused && Math.random() < 0.75) {
                    spawnZone('coin');
                }
            }, 25000)
        ];
    }
    function spawnZone(type) {
     const zoneLimit = { red: 8, blue: 1, purple: 1, coin: 1 };
    const currentCount = zones.filter(z => z.type === type).length;
    
    if (currentCount >= zoneLimit[type]) return; // Don't spawn if limit reached
   
    // 1. Definimos el radio (tama√±o) seg√∫n el tipo de objeto
    let r;
    if (type === 'red') {
        r = 60; // √Årea de explosi√≥n grande
    } else if (type === 'coin') {
        r = 12; // Moneda peque√±a
    } else {
        r = 45; // Azul (inmune) y Morada (lodo)
    }

    // 2. Creamos el objeto con sus propiedades base
    zones.push({
        x: Math.random() * 800 + 50, 
        y: Math.random() * 450 + 50, 
        r: r, 
        type: type, 
        a: 0, 
        active: (type !== 'red') // Las rojas nacen inactivas (amarillas), el resto activas
    });
}
    function endGame(reason) {
        gameOver = true;
        if (navigator.vibrate) navigator.vibrate([200, 50, 200]);
        document.getElementById('death-reason').innerText = "Causa: " + reason;
        document.getElementById('final-lvl').innerText = level;
        document.getElementById('game-over').classList.remove('hidden');
        if(level > (localStorage.getItem('billarHigh')||0)) localStorage.setItem('billarHigh', level);
    }

    function getPos(e) {
        let r = canvas.getBoundingClientRect();
        let cx = e.touches ? e.touches[0].clientX : e.clientX;
        let cy = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: (cx - r.left)*(900/r.width), y: (cy - r.top)*(550/r.height) };
    }

    const hStart = (e) => { if(ball.vx===0 && isStarted && !isPaused) { isDrawing=true; curPos=getPos(e); } };
    const hMove = (e) => { curPos=getPos(e); if(isDrawing) e.preventDefault(); };
    const hEnd = () => { 
    if(isDrawing) { 
        playSound(300, 'triangle', 0.1); 
        
        // Calculamos la diferencia de posici√≥n
        let dx = ball.x - curPos.x;
        let dy = ball.y - curPos.y;
        let power = 0.14;

        if (controlType === 1) {
            // MODO DIRECTO: Invierte la direcci√≥n para que vaya HACIA el puntero
            ball.vx = -dx * power; 
            ball.vy = -dy * power;
        } else {
            // MODO HONDA: (Tu c√≥digo original) sale disparado al lado OPUESTO
            ball.vx = dx * power; 
            ball.vy = dy * power;
        }
        
        isDrawing = false; 
    } 
};

    window.addEventListener('keydown', (e) => { if(e.key.toLowerCase()==='p' || e.key==='Escape') togglePause(); });
    canvas.addEventListener('mousedown', hStart); window.addEventListener('mousemove', hMove); window.addEventListener('mouseup', hEnd);
    canvas.addEventListener('touchstart', hStart, {passive:false}); canvas.addEventListener('touchmove', hMove, {passive:false}); canvas.addEventListener('touchend', hEnd);
class Pixel {
    constructor(x, y, col) {
        this.x = x; this.y = y; this.col = col;
        this.l = 1.0; this.v = Math.random() * 2 + 1;
    }
    update() { this.y -= this.v; this.l -= 0.02; }
    draw() {
        ctx.globalAlpha = this.l;
        ctx.fillStyle = this.col;
        ctx.fillRect(this.x, this.y, 3, 3);
        ctx.globalAlpha = 1.0;
    }
}
function update() {
    if(!isStarted || gameOver || isPaused) return;

    // 1. F√≠sicas de la bola
    ball.x += ball.vx; 
    ball.y += ball.vy;
    ball.vx *= ball.f; 
    ball.vy *= ball.f;

    let speed = Math.hypot(ball.vx, ball.vy);
    if (speed < 0.5) {
        energy -= energyDrain; 
    } else {
        energy = Math.min(100, energy + 0.4); 
    }

    // UI de Energ√≠a
    const eBar = document.getElementById('energy-bar');
    if(eBar) {
        eBar.style.width = (energy > 0 ? energy : 0) + "%";
        eBar.style.background = energy < 30 ? "#f44336" : "#ffeb3b";
    }

    const warningText = document.getElementById('camping-warning');
    if (warningText) warningText.style.opacity = energy < 50 ? "1" : "0";

    if (energy <= 0 && isStarted && !gameOver) {
        energy = 0; 
        endGame("INACTIVIDAD (ANTI-CAMPING)");
        return;
    }

    if(Math.hypot(ball.vx, ball.vy) < 0.5) { ball.vx=0; ball.vy=0; }

    // Rebotar en bordes
    if(ball.x<ball.r || ball.x>900-ball.r) { ball.vx*=-0.8; ball.x=ball.x<ball.r?ball.r:900-ball.r; playSound(150,'sine',0.05); }
    if(ball.y<ball.r || ball.y>550-ball.r) { ball.vy*=-0.8; ball.y=ball.y<ball.r?ball.r:550-ball.r; playSound(150,'sine',0.05); }

    // 2. Bucle de Zonas (Corregido)
    zones.forEach((z, i) => {
        z.a++;
        if(z.type === 'red' && z.a > warningTime) z.active = true;
        let dist = Math.hypot(ball.x - z.x, ball.y - z.y);

        if(z.type === 'coin' && dist < ball.r + z.r) {
            coins += 1;
            localStorage.setItem('billarCoins', coins);
            playSound(800, 'triangle', 0.2);
            zones.splice(i, 1);
            return;
        }
        
        if(dist < ball.r + z.r) {
            if(z.type === 'red' && z.active && !ball.immune) endGame("EXPLOSI√ìN");
            if(z.type === 'blue') {
                ball.immune = true;
                document.getElementById('status-effect').innerText = "üõ°Ô∏è INMUNE";
                playSound(600, 'sine', 0.2);
                setTimeout(() => { ball.immune = false; document.getElementById('status-effect').innerText = ""; }, 10000);
                zones.splice(i, 1);
            }
            if(z.type === 'purple') { ball.vx *= 0.85; ball.vy *= 0.85; }
        }

        if(Math.random() > 0.8) {
            let pCol = z.type==='red'?(z.active?"red":"yellow"): (z.type==='blue'?"#00fbff":"#b400ff");
            particles.push(new Pixel(z.x+(Math.random()-0.5)*z.r, z.y+(Math.random()-0.5)*z.r, pCol));
        }

        let lifeTime = warningTime * 3;
        if(z.a > lifeTime) { 
            zones.splice(i, 1); 
        }
    }); // <-- ESTO CIERRA EL ZONES.FOREACH CORRECTAMENTE

    // 3. Bucle de Part√≠culas (Independiente)
    particles.forEach((p, i) => { 
        p.update(); 
        if(p.l <= 0) particles.splice(i, 1); 
    });
} // <-- ESTO CIERRA LA FUNCI√ìN UPDATE

function draw() {
    ctx.clearRect(0,0,900,550);
    if(!isStarted) return;

    // DIBUJO DE ZONAS Y MONEDAS
    zones.forEach(z => {
        ctx.beginPath(); 
        ctx.arc(z.x, z.y, z.r, 0, Math.PI*2);

        if(z.type === 'red') {
            ctx.fillStyle = z.active ? "rgba(255,0,0,0.3)" : "rgba(255,255,0,0.15)";
            ctx.strokeStyle = z.active ? "red" : "yellow";
        } else if(z.type === 'blue') {
            ctx.fillStyle = "rgba(0,251,255,0.2)"; 
            ctx.strokeStyle = "#00fbff";
        } else if(z.type === 'purple') {
            ctx.fillStyle = "rgba(180,0,255,0.2)"; 
            ctx.strokeStyle = "#b400ff";
        } else if(z.type === 'coin') {
            ctx.fillStyle = "#ffeb3b";
            ctx.strokeStyle = "#ffffff";
            ctx.shadowBlur = 10;
            ctx.shadowColor = "yellow";
        }

        ctx.lineWidth=3; 
        ctx.fill(); 
        ctx.stroke();
        ctx.shadowBlur = 0; 
    });

    particles.forEach(p => p.draw());

    // DIBUJO DE LA BOLA (CON SKINS)
    ctx.save();
    let currentSkinData = skinStore.find(s => s.id === activeSkin);
    
    if(ball.immune) { 
        ctx.shadowBlur = 15; 
        ctx.shadowColor = "#00fbff"; 
    }

    ctx.fillStyle = ball.immune ? "#00fbff" : (currentSkinData ? currentSkinData.color : "white");
    
    ctx.beginPath(); 
    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); 
    ctx.fill();
    ctx.strokeStyle="black"; 
    ctx.lineWidth=2; 
    ctx.stroke();
    ctx.restore();
    
    // DIBUJO DEL TACO Y GU√çA CORREGIDA
    if(isDrawing) {
        let dx = ball.x - curPos.x;
        let dy = ball.y - curPos.y;
        let ang = Math.atan2(dy, dx);
        let dist = Math.hypot(dx, dy);

        // 1. Dibujo del Taco
        ctx.save(); 
        ctx.translate(ball.x, ball.y); 
        if (controlType === 1) {
            ctx.rotate(ang + Math.PI); // Taco apunta hacia el dedo
        } else {
            ctx.rotate(ang); // Taco en lado opuesto (honda)
        }
        ctx.fillStyle="#5d4037"; ctx.fillRect(-dist-150, -4, 150, 8);
        ctx.fillStyle="#d7ccc8"; ctx.fillRect(-dist-10, -4, 10, 8);
        ctx.restore();

        // 2. Dibujo de la Gu√≠a (Puntitos)
        ctx.setLineDash([8,8]); 
        ctx.strokeStyle="rgba(255,255,255,0.5)";
        ctx.beginPath(); 
        ctx.moveTo(ball.x, ball.y);

        if (controlType === 1) {
            // Gu√≠a Directa: va hacia el dedo
            ctx.lineTo(curPos.x, curPos.y); 
        } else {
            // Gu√≠a Honda: va hacia el lado opuesto del dedo
            let targetX = ball.x + dx * 5; 
            let targetY = ball.y + dy * 5;
            ctx.lineTo(targetX, targetY);
        }
        
        ctx.stroke();
        ctx.setLineDash([]);
    }
}
    function run() { update(); draw(); requestAnimationFrame(run); }
    run();
function updateShopUI() {
    document.getElementById('coin-count-ui').innerText = coins;
    const list = document.getElementById('skin-list');
    list.innerHTML = '';

    skinStore.forEach((skin, index) => {
    const isOwned = ownedSkins.includes(skin.id);
    
    // ESTA ES LA L√çNEA CLAVE:
    // Si la skin es de las primeras 4 (0,1,2,3) cuesta 2.
    // Si es de las siguientes 4 cuesta 5, y as√≠ sucesivamente.
    const price = index < 4 ? 2 : (index < 8 ? 5 : (index < 12 ? 10 : 20));
    
    const btn = document.createElement('div');
    btn.style = `width: 50px; height: 50px; background: ${skin.color}; border-radius: 50%; border: ${activeSkin === skin.id ? '4px solid white' : '2px solid #000'}; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; color: black; font-weight: bold; margin: 5px; flex-shrink: 0;`;
    
    // Aqu√≠ es donde el bot√≥n muestra el precio calculado arriba
    btn.innerText = isOwned ? (activeSkin === skin.id ? 'USANDO' : 'USAR') : `${price} üí∞`;
    
    btn.onclick = () => {
        if(isOwned) {
            activeSkin = skin.id;
            localStorage.setItem('billarSkin', skin.id);
        } else if(coins >= price) {
            coins -= price;
            ownedSkins.push(skin.id);
            activeSkin = skin.id;
            localStorage.setItem('billarCoins', coins);
            localStorage.setItem('billarOwned', JSON.stringify(ownedSkins));
            localStorage.setItem('billarSkin', skin.id);
        }
        updateShopUI(); // Refresca para mostrar el nuevo estado
    };
    list.appendChild(btn);
});
}
function resetGame() {
    // 1. Limpiamos el estado de derrota
    gameOver = false;
    isStarted = false;
    document.getElementById('game-over').classList.add('hidden');
    document.getElementById('start-menu').classList.remove('hidden');
    document.getElementById('diff-slider').value = currentDiffIndex;
    applyDiff(currentDiffIndex)
    
}
function applyDiff(index) {
    // 1. Guardamos el √≠ndice actual globalmente
    currentDiffIndex = index;
    
    // 2. Guardamos la elecci√≥n en el navegador
    localStorage.setItem('billarDiff', index);
    
    // 3. Verificamos si el nivel est√° desbloqueado
    const label = document.getElementById('diff-label');
    const isUnlocked = index === 0 || unlockedDiffs.includes(diffs[index].id);
    const prevUnlocked = index === 0 || unlockedDiffs.includes(diffs[index-1].id);
    
    // 4. Si el nivel o el anterior est√°n bloqueados, ponemos el candado
    let lockIcon = (!isUnlocked || !prevUnlocked) ? "üîí " : "";
    let text = "DIFICULTAD: " + lockIcon + diffs[index].name;
    
    // 5. Pista para el siguiente nivel
    if(index + 1 < diffs.length) {
        const next = diffs[index + 1];
        if(!unlockedDiffs.includes(next.id)) {
            text += ` (Pr√≥ximo: ${next.price}üí∞)`;
        }
    }
    
    // 6. Aplicamos el texto y cambiamos el color (gris si est√° bloqueado)
    label.innerText = text;
    label.style.color = isUnlocked ? diffs[index].col : "#888";
}
window.addEventListener('load', () => {
    // Sincroniza el slider visualmente
    document.getElementById('diff-slider').value = currentDiffIndex;
    // Aplica la dificultad visualmente
    applyDiff(currentDiffIndex);
});
function playSound(freq, type, vol) {
    if(!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.2);
}
</script>
</body>
</html>
