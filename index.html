<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <title>Billar Survival Pro</title>
    <style>
        body { 
            background: #1a1a1a; display: flex; flex-direction: column; align-items: center; 
            color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden;
            touch-action: none; /* Evita gestos del navegador como "pull-to-refresh" */
        }
        
        canvas { 
            background: #074e1d; border: 10px solid #3e2723; border-radius: 8px; 
            box-shadow: 0 0 30px rgba(0,0,0,0.7); cursor: crosshair; 
            margin-top: 10px; max-width: 95vw; max-height: 70vh; height: auto;
            touch-action: none; image-rendering: auto;
        }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .menu-card { background: #2c2c2c; padding: 25px; border-radius: 20px; border: 4px solid #4caf50; text-align: center; width: 85%; max-width: 450px; }
        
        /* Selector de Dificultad */
        .difficulty-container { margin: 15px 0; background: #1a1a1a; padding: 15px; border-radius: 15px; border: 1px solid #444; }
        .diff-label { font-weight: bold; color: #4deeea; font-size: 20px; margin-bottom: 8px; display: block; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #4caf50; }
        .diff-steps { display: flex; justify-content: space-between; font-size: 9px; color: #888; margin-top: 5px; }

        button { background: #4caf50; border: none; padding: 15px 35px; color: white; font-size: 22px; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.2s; -webkit-tap-highlight-color: transparent; }
        
        .stats-panel { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; font-size: 16px; margin-top: 10px; background: #333; padding: 10px 20px; border-radius: 20px; border: 2px solid #555; }
        .hidden { display: none !important; }
        #level-up-msg { position: absolute; top: 40%; font-size: 40px; color: #ffeb3b; font-weight: bold; text-shadow: 3px 3px #000; pointer-events: none; opacity: 0; transition: 0.5s; z-index: 50; text-align: center; width: 100%; }
    </style>
</head>
<body>

    <div id="start-menu" class="overlay">
        <div class="menu-card">
            <h1 style="margin: 0 0 10px 0;">BILLAR SURVIVAL</h1>
            <div id="record-init" style="color: #ffeb3b; margin-bottom: 10px;">üèÜ R√âCORD: NIVEL 1</div>
            
            <div class="difficulty-container">
                <span class="diff-label" id="diff-name">BASE</span>
                <input type="range" id="diff-slider" min="0" max="5" value="0" oninput="updateDiffLabel(this.value)">
                <div class="diff-steps">
                    <span>BASE</span><span>DIF</span><span>TREM</span><span>DUR</span><span>EXT</span><span>LOC</span>
                </div>
            </div>

            <button onclick="startGame()">JUGAR</button>
        </div>
    </div>

    <div id="game-over-menu" class="overlay hidden">
        <div class="menu-card">
            <h1 style="color: #ff5252;">¬°BOOM!</h1>
            <div style="font-size: 24px; margin-bottom: 15px;">NIVEL: <span id="final-level">1</span></div>
            <button onclick="location.reload()">REINTENTAR</button>
        </div>
    </div>

    <div id="level-up-msg">¬°NIVEL COMPLETADO!<br>+10% DIFICULTAD</div>

    <div class="stats-panel">
        <div style="color: #4caf50; font-weight: bold;">LVL: <span id="lvl-val">1</span></div>
        <div>‚è±Ô∏è: <span id="timer">01:30</span></div>
        <div id="status-msg" style="color: #00fbff; font-weight: bold;"></div>
        <div id="camping-alert" style="color:#ffeb3b; font-weight: bold;"></div>
    </div>
    
    <canvas id="gameCanvas" width="900" height="550"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let isStarted = false, gameOver = false;
    let ball, zones, particles, timeLeft, idleTime, level, difficultyMultiplier;
    let spawnRate, warningTime, gameIntervals = [];

    const diffNames = ["BASE", "DIF√çCIL", "TREMENDO", "DUR√çSIMO", "EXTREMO", "LOCURA"];
    const diffMultipliers = [1.0, 1.3, 1.7, 2.1, 2.5, 3.0];

    function updateDiffLabel(val) {
        const label = document.getElementById('diff-name');
        label.innerText = diffNames[val];
        const colors = ["#4deeea", "#4caf50", "#ffeb3b", "#ff9800", "#f44336", "#9c27b0"];
        label.style.color = colors[val];
    }

    class Particle {
        constructor(x, y, color, speed) {
            this.x = x; this.y = y; this.color = color;
            this.vx = (Math.random() - 0.5) * speed;
            this.vy = (Math.random() - 0.5) * speed;
            this.life = 1.0; this.decay = Math.random() * 0.03 + 0.02;
            this.size = Math.random() * 3 + 1;
        }
        update() { this.x += this.vx; this.y += this.vy; this.life -= this.decay; }
        draw() {
            ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
            ctx.fillRect(this.x, this.y, this.size, this.size); // Estilo pixel
            ctx.globalAlpha = 1;
        }
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(freq, type, duration, vol = 0.1) {
        if (!isStarted) return;
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    function initVars() {
        const selectedDiff = document.getElementById('diff-slider').value;
        difficultyMultiplier = diffMultipliers[selectedDiff];
        ball = { x: 450, y: 275, vx: 0, vy: 0, radius: 15, friction: 0.985, immune: false };
        zones = []; particles = []; timeLeft = 90; idleTime = 0; level = 1;
        spawnRate = 1800 / difficultyMultiplier; warningTime = 180 / difficultyMultiplier;
        document.getElementById('lvl-val').innerText = level;
    }

    function startGame() {
        initVars();
        document.getElementById('start-menu').classList.add('hidden');
        isStarted = true;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        document.getElementById('record-init').innerText = "üèÜ R√âCORD: NIVEL " + (localStorage.getItem('billarLvlRecord') || 1);
        startLoops();
    }

    function startLoops() {
        gameIntervals.forEach(clearInterval);
        gameIntervals = [
            setInterval(() => {
                if (gameOver) return;
                if (ball.vx === 0 && ball.vy === 0) {
                    idleTime++;
                    if (idleTime >= 4) document.getElementById('camping-alert').innerText = `¬°MU√âVETE! ${10 - idleTime}s`;
                    if (idleTime >= 10) endGame("INACTIVIDAD");
                } else { idleTime = 0; document.getElementById('camping-alert').innerText = ""; }
            }, 1000),
            setInterval(() => {
                if (gameOver) return;
                if (timeLeft > 0) {
                    timeLeft--;
                    let m = Math.floor(timeLeft/60), s = timeLeft%60;
                    document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
                } else {
                    level++; difficultyMultiplier *= 1.10;
                    spawnRate = Math.max(400, 1800 / difficultyMultiplier);
                    warningTime = Math.max(50, 180 / difficultyMultiplier);
                    timeLeft = 90; document.getElementById('lvl-val').innerText = level;
                    const msg = document.getElementById('level-up-msg');
                    msg.style.opacity = "1"; setTimeout(() => msg.style.opacity = "0", 2000);
                }
            }, 1000),
            setInterval(() => { if(!gameOver) spawnZone('red'); }, spawnRate)
        ];
    }

    function spawnZone(type) { zones.push({ x: Math.random() * (canvas.width - 150) + 75, y: Math.random() * (canvas.height - 150) + 75, radius: 60, type, age: 0, activated: false }); }

    function endGame(reason) {
        gameOver = true;
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        playSound(100, 'sawtooth', 0.5, 0.2);
        let high = localStorage.getItem('billarLvlRecord') || 1;
        if (level > high) localStorage.setItem('billarLvlRecord', level);
        document.getElementById('final-level').innerText = level;
        document.getElementById('game-over-menu').classList.remove('hidden');
    }

    // L√≥gica T√°ctil y Rat√≥n unificada
    let isDrawing = false, curPos = {x:0, y:0};
    
    function getPos(e) {
        let rect = canvas.getBoundingClientRect();
        let clientX = e.touches ? e.touches[0].clientX : e.clientX;
        let clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: (clientX - rect.left) * (canvas.width / rect.width),
            y: (clientY - rect.top) * (canvas.height / rect.height)
        };
    }

    const handleStart = (e) => { if(ball.vx === 0 && isStarted) { isDrawing = true; curPos = getPos(e); } };
    const handleMove = (e) => { curPos = getPos(e); if(isDrawing) e.preventDefault(); };
    const handleEnd = () => {
        if(isDrawing) {
            playSound(300, 'triangle', 0.1);
            ball.vx = (ball.x - curPos.x) * 0.14;
            ball.vy = (ball.y - curPos.y) * 0.14;
            isDrawing = false;
        }
    };

    canvas.addEventListener('mousedown', handleStart);
    window.addEventListener('mousemove', handleMove);
    window.addEventListener('mouseup', handleEnd);
    canvas.addEventListener('touchstart', handleStart, {passive: false});
    window.addEventListener('touchmove', handleMove, {passive: false});
    window.addEventListener('touchend', handleEnd);

    function update() {
        if (!isStarted || gameOver) return;
        ball.x += ball.vx; ball.y += ball.vy;
        ball.vx *= ball.friction; ball.vy *= ball.friction;
        if (Math.hypot(ball.vx, ball.vy) < 1) { ball.vx = 0; ball.vy = 0; }

        // Rebotes con vibraci√≥n sutil
        if (ball.x < ball.radius || ball.x > canvas.width - ball.radius) { 
            ball.vx *= -0.8; ball.x = (ball.x < ball.radius) ? ball.radius : canvas.width - ball.radius;
            if (navigator.vibrate) navigator.vibrate(20);
        }
        if (ball.y < ball.radius || ball.y > canvas.height - ball.radius) { 
            ball.vy *= -0.8; ball.y = (ball.y < ball.radius) ? ball.radius : canvas.height - ball.radius;
            if (navigator.vibrate) navigator.vibrate(20);
        }

        zones.forEach((z, i) => {
            z.age++;
            if (z.age > warningTime) z.activated = true;
            if (Math.random() > 0.8) particles.push(new Particle(z.x + (Math.random()-0.5)*z.radius, z.y + (Math.random()-0.5)*z.radius, z.activated ? "red" : "yellow", 2));
            
            if (Math.hypot(ball.x - z.x, ball.y - z.y) < ball.radius + z.radius && z.activated) endGame();
            if (z.age > warningTime * 2.5) zones.splice(i, 1);
        });

        particles.forEach((p, i) => { p.update(); if(p.life <= 0) particles.splice(i, 1); });
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if(!isStarted) return;
        zones.forEach(z => {
            ctx.beginPath(); ctx.arc(z.x, z.y, z.radius, 0, Math.PI*2);
            ctx.fillStyle = z.activated ? "rgba(255,0,0,0.3)" : "rgba(255,255,0,0.15)";
            ctx.strokeStyle = z.activated ? "red" : "yellow";
            ctx.fill(); ctx.stroke();
        });
        particles.forEach(p => p.draw());
        ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
        ctx.fillStyle = "white"; ctx.fill(); ctx.strokeStyle = "black"; ctx.stroke();
        
        if(isDrawing) {
            let dx = ball.x - curPos.x, dy = ball.y - curPos.y;
            let angle = Math.atan2(dy, dx), dist = Math.hypot(dx, dy);
            ctx.save(); ctx.translate(ball.x, ball.y); ctx.rotate(angle);
            ctx.fillStyle = "#5d4037"; ctx.fillRect(-dist - 150, -4, 150, 8);
            ctx.restore();
        }
    }

    function loop() { update(); draw(); requestAnimationFrame(loop); }
    loop();
</script>
</body>
</html>
