<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Billar Survival - Difficulty Selection</title>
    <style>
        body { background: #1a1a1a; display: flex; flex-direction: column; align-items: center; color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; }
        canvas { background: #074e1d; border: 15px solid #3e2723; border-radius: 8px; box-shadow: 0 0 30px rgba(0,0,0,0.7); cursor: crosshair; margin-top: 10px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .menu-card { background: #2c2c2c; padding: 30px; border-radius: 20px; border: 4px solid #4caf50; text-align: center; max-width: 500px; }
        
        /* Estilos del Selector de Dificultad */
        .difficulty-container { margin: 20px 0; background: #1a1a1a; padding: 20px; border-radius: 15px; border: 1px solid #444; }
        .diff-label { font-weight: bold; color: #4deeea; font-size: 22px; margin-bottom: 10px; display: block; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #4caf50; }
        .diff-steps { display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-top: 5px; }

        .guide { display: grid; grid-template-columns: 40px 1fr; gap: 10px; text-align: left; margin: 15px 0; background: #1a1a1a; padding: 15px; border-radius: 10px; font-size: 14px; }
        .dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid white; align-self: center; }
        .yellow-dot { background: #ffeb3b; } .red-dot { background: red; } .blue-dot { background: cyan; } .purple-dot { background: purple; }
        button { background: #4caf50; border: none; padding: 12px 30px; color: white; font-size: 20px; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        button:hover { background: #66bb6a; transform: scale(1.05); }
        .stats-panel { display: flex; gap: 20px; font-size: 18px; margin-top: 10px; background: #333; padding: 8px 25px; border-radius: 20px; border: 2px solid #555; align-items: center; }
        .hidden { display: none !important; }
        #level-up-msg { position: absolute; top: 40%; font-size: 60px; color: #ffeb3b; font-weight: bold; text-shadow: 4px 4px #000; pointer-events: none; opacity: 0; transition: 0.5s; z-index: 50; }
    </style>
</head>
<body>

    <div id="start-menu" class="overlay">
        <div class="menu-card">
            <h1>BILLAR SURVIVAL</h1>
            <div id="record-init" style="font-size: 18px; color: #ffeb3b; margin-bottom: 5px;">üèÜ R√âCORD: NIVEL 1</div>
            
            <div class="difficulty-container">
                <span class="diff-label" id="diff-name">BASE</span>
                <input type="range" id="diff-slider" min="0" max="5" value="0" oninput="updateDiffLabel(this.value)">
                <div class="diff-steps">
                    <span>BASE</span><span>DIF√çCIL</span><span>TREMENDO</span><span>DUR√çSIMO</span><span>EXTREMO</span><span>LOCURA</span>
                </div>
            </div>

            <div class="guide">
                <div class="dot red-dot"></div> <div><b>Rojo:</b> Explosi√≥n. | <b>Azul:</b> Inmune.</div>
            </div>
            <button onclick="startGame()">INICIAR RUN</button>
        </div>
    </div>

    <div id="game-over-menu" class="overlay hidden">
        <div class="menu-card"><h1 style="color: #ff5252;">¬°BOOM!</h1><p id="over-reason"></p><div style="font-size: 28px; margin: 15px 0;">NIVEL: <span id="final-level">1</span></div><button onclick="resetGame()">REINTENTAR</button></div>
    </div>

    <div id="level-up-msg">¬°DIFICULTAD +10%!</div>

    <div class="stats-panel">
        <div style="color: #4caf50; font-weight: bold;">LVL: <span id="lvl-val">1</span></div>
        <div>‚è±Ô∏è: <span id="timer">01:30</span></div>
        <div id="status-msg" style="color: #00fbff; font-weight: bold;"></div>
        <div id="camping-alert" style="color:#ffeb3b; font-weight: bold;"></div>
    </div>
    <canvas id="gameCanvas" width="900" height="550"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let isStarted = false, isPaused = false, gameOver = false;
    let ball, zones, particles, timeLeft, idleTime, level, difficultyMultiplier;
    let spawnRate, warningTime, gameIntervals = [];

    const diffNames = ["BASE", "DIF√çCIL", "TREMENDO", "DUR√çSIMO", "EXTREMO", "LOCURA"];
    const diffMultipliers = [1.0, 1.3, 1.6, 1.9, 2.2, 2.5];

    function updateDiffLabel(val) {
        const label = document.getElementById('diff-name');
        label.innerText = diffNames[val];
        // Cambio de color seg√∫n agresividad
        const colors = ["#4deeea", "#4caf50", "#ffeb3b", "#ff9800", "#f44336", "#9c27b0"];
        label.style.color = colors[val];
    }

    class Particle {
        constructor(x, y, color, speedScale = 1) {
            this.x = x; this.y = y; this.color = color;
            this.vx = (Math.random() - 0.5) * 3 * speedScale;
            this.vy = (Math.random() - 0.5) * 3 * speedScale;
            this.life = 1.0; this.decay = Math.random() * 0.03 + 0.02;
            this.size = Math.random() * 3 + 1;
        }
        update() { this.x += this.vx; this.y += this.vy; this.life -= this.decay; }
        draw() { ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1; }
    }

    function initVars() {
        const selectedDiffIndex = document.getElementById('diff-slider').value;
        difficultyMultiplier = diffMultipliers[selectedDiffIndex];
        
        ball = { x: 450, y: 275, vx: 0, vy: 0, radius: 15, friction: 0.985, immune: false };
        zones = []; particles = []; timeLeft = 90; idleTime = 0; level = 1;
        
        // El spawn rate y warning se ven afectados por la dificultad inicial
        spawnRate = 1800 / difficultyMultiplier; 
        warningTime = 180 / difficultyMultiplier; 
        
        gameOver = false; isPaused = false;
        document.getElementById('lvl-val').innerText = level;
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(freq, type, duration, vol = 0.1) {
        if (!isStarted || isPaused) return;
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    function startGame() { 
        initVars(); 
        document.getElementById('start-menu').classList.add('hidden'); 
        isStarted = true; 
        if (audioCtx.state === 'suspended') audioCtx.resume(); 
        document.getElementById('record-init').innerText = "üèÜ R√âCORD: NIVEL " + (localStorage.getItem('billarLvlRecord') || 1);
        startLoops(); 
    }

    function showGameOver(reason) {
        gameOver = true; gameIntervals.forEach(clearInterval);
        let savedHigh = parseInt(localStorage.getItem('billarLvlRecord') || 1);
        if (level > savedHigh) localStorage.setItem('billarLvlRecord', level);
        document.getElementById('final-level').innerText = level;
        document.getElementById('over-reason').innerText = reason;
        document.getElementById('game-over-menu').classList.remove('hidden');
        playSound(100, 'sawtooth', 0.4, 0.2);
    }

    function startLoops() {
        gameIntervals.forEach(clearInterval); gameIntervals = [];
        gameIntervals.push(setInterval(() => {
            if (gameOver) return;
            if (ball.vx === 0 && ball.vy === 0) {
                idleTime++;
                if (idleTime >= 4) document.getElementById('camping-alert').innerText = `¬°MU√âVETE! ${10 - idleTime}s`;
                if (idleTime >= 10) showGameOver("Inactividad.");
            } else { idleTime = 0; document.getElementById('camping-alert').innerText = ""; }
        }, 1000));
        
        gameIntervals.push(setInterval(() => {
            if (gameOver) return;
            if (timeLeft > 0) {
                timeLeft--;
                let m = Math.floor(timeLeft/60), s = timeLeft%60;
                document.getElementById('timer').innerText = `${m}:${s < 10 ? '0'+s : s}`;
            } else {
                level++; 
                difficultyMultiplier *= 1.10; // Aumento del 10% cada nivel
                spawnRate = Math.max(400, 1800 / difficultyMultiplier);
                warningTime = Math.max(50, 180 / difficultyMultiplier);
                timeLeft = 90; 
                document.getElementById('lvl-val').innerText = level;
                document.getElementById('level-up-msg').style.opacity = "1";
                playSound(500, 'sine', 0.2);
                setTimeout(() => document.getElementById('level-up-msg').style.opacity = "0", 2000);
            }
        }, 1000));
        
        // Generaci√≥n de zonas usando las tasas calculadas
        const zoneSpawner = () => {
            if(!gameOver) {
                spawnZone('red');
                setTimeout(zoneSpawner, spawnRate);
            }
        };
        zoneSpawner();

        gameIntervals.push(setInterval(() => { if(!gameOver) { spawnZone('blue'); spawnZone('purple'); } }, 15000));
    }

    function spawnZone(type) { zones.push({ x: Math.random() * (canvas.width - 150) + 75, y: Math.random() * (canvas.height - 150) + 75, radius: (type === 'blue') ? 48 : 65, type: type, age: 0, activated: (type !== 'red') }); }

    function update() {
        if (!isStarted || gameOver) return;
        ball.x += ball.vx; ball.y += ball.vy;
        ball.vx *= ball.friction; ball.vy *= ball.friction;
        if (Math.hypot(ball.vx, ball.vy) < 1.2) { ball.vx = 0; ball.vy = 0; }

        // Colisi√≥n con paredes (Separaci√≥n forzada para evitar bucles de sonido)
        if (ball.x - ball.radius < 0) { ball.x = ball.radius; ball.vx *= -0.8; playSound(150, 'sine', 0.05); }
        else if (ball.x + ball.radius > canvas.width) { ball.x = canvas.width - ball.radius; ball.vx *= -0.8; playSound(150, 'sine', 0.05); }
        if (ball.y - ball.radius < 0) { ball.y = ball.radius; ball.vy *= -0.8; playSound(150, 'sine', 0.05); }
        else if (ball.y + ball.radius > canvas.height) { ball.y = canvas.height - ball.radius; ball.vy *= -0.8; playSound(150, 'sine', 0.05); }

        zones.forEach((z, i) => {
            z.age++;
            if (z.type === 'red' && z.age >= warningTime && !z.activated) z.activated = true;
            
            if (Math.random() > 0.75) {
                let color = z.type === 'red' ? (z.activated ? "red" : "orange") : (z.type === 'blue' ? "#00fbff" : "#b400ff");
                particles.push(new Particle(z.x + (Math.random()-0.5)*z.radius, z.y + (Math.random()-0.5)*z.radius, color, z.activated ? 1.5 : 0.5));
            }

            let dist = Math.hypot(ball.x - z.x, ball.y - z.y);
            if (dist < ball.radius + z.radius) {
                if (z.type === 'red' && z.activated && !ball.immune) showGameOver("¬°Explosi√≥n!");
                else if (z.type === 'blue') {
                    ball.immune = true; document.getElementById('status-msg').innerText = "üõ°Ô∏è INMUNE";
                    setTimeout(() => { ball.immune = false; document.getElementById('status-msg').innerText = ""; }, 5000);
                    zones.splice(i, 1);
                }
                else if (z.type === 'purple') { ball.vx *= 0.85; ball.vy *= 0.85; }
            }
            if (z.age >= (warningTime * 2.2)) zones.splice(i, 1);
        });

        particles.forEach((p, i) => { p.update(); if (p.life <= 0) particles.splice(i, 1); });
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if(!isStarted) return;
        zones.forEach(z => {
            ctx.beginPath(); ctx.arc(z.x, z.y, z.radius, 0, Math.PI*2);
            if (z.type === 'red') { ctx.fillStyle = z.activated ? "rgba(255,0,0,0.3)" : "rgba(255,255,0,0.15)"; ctx.strokeStyle = z.activated ? "red" : "yellow"; }
            else if (z.type === 'blue') { ctx.fillStyle = "rgba(0,200,255,0.2)"; ctx.strokeStyle = "cyan"; }
            else { ctx.fillStyle = "rgba(180,0,255,0.2)"; ctx.strokeStyle = "purple"; }
            ctx.fill(); ctx.stroke();
        });
        particles.forEach(p => p.draw());
        ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
        ctx.fillStyle = ball.immune ? '#00fbff' : 'white';
        ctx.fill(); ctx.strokeStyle = "black"; ctx.stroke();
        if (mouseDownPos && ball.vx === 0) {
            let dx = ball.x - curMousePos.x, dy = ball.y - curMousePos.y;
            let angle = Math.atan2(dy, dx), dist = Math.hypot(dx, dy);
            ctx.save();
            ctx.beginPath(); ctx.setLineDash([8, 8]); ctx.strokeStyle = "white";
            ctx.moveTo(ball.x, ball.y); ctx.lineTo(ball.x + Math.cos(angle) * 1000, ball.y + Math.sin(angle) * 1000); ctx.stroke();
            ctx.translate(ball.x, ball.y); ctx.rotate(angle);
            ctx.fillStyle = "#5d4037"; ctx.fillRect(-dist - 150, -4, 150, 8); // Color madera
            ctx.restore();
        }
    }

    let mouseDownPos = null, curMousePos = {x:0, y:0};
    canvas.addEventListener('mousedown', () => { if(ball.vx === 0 && isStarted) mouseDownPos = true; });
    window.addEventListener('mousemove', (e) => { let rect = canvas.getBoundingClientRect(); curMousePos.x = e.clientX - rect.left; curMousePos.y = e.clientY - rect.top; });
    window.addEventListener('mouseup', () => { if (mouseDownPos) { playSound(300, 'triangle', 0.1); ball.vx = (ball.x - curMousePos.x) * 0.14; ball.vy = (ball.y - curMousePos.y) * 0.14; mouseDownPos = null; } });

    function resetGame() { document.getElementById('game-over-menu').classList.add('hidden'); document.getElementById('start-menu').classList.remove('hidden'); }
    function loop() { update(); draw(); requestAnimationFrame(loop); }
    updateDiffLabel(0); loop();
</script>
</body>
</html>
